<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="google" content="notranslate">
    <title>Add New Product - LocalMarket</title>
    <link href="../style.css" rel="stylesheet">
  </head>
  <body>

    <!-- Fixed Top Header -->
    <div class="top-header">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <img src="../text.png" alt="Local Market Wordmark" loading="lazy" style="height: 40px; filter: var(--wordmark-filter);">
      </div>
      <nav class="header-nav">
        <a href="../home/index.html" class="link" data-testid="desktop-nav-home">Home</a>
        <a href="../index.html" class="link" data-testid="desktop-nav-discovery">Discover</a>
        <a href="../discussions/categories/local-discussions.html" class="link" data-testid="desktop-nav-community">Community</a>
        <a href="../cart/index.html" class="link" data-testid="desktop-nav-cart">
          <i>shopping_cart</i>
          <span>Cart</span>
        </a>
      </nav>
      <div class="header-right">
        <a href="../index.html" class="site-logo">
          <img src="../Logo 333.png" alt="LocalMarket Logo">
        </a>
        <a href="../userprofile/index.html" class="header-profile" data-testid="desktop-nav-profile">
          <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=60&h=60&fit=crop&crop=face" alt="Profile" loading="lazy" class="circle small">
        </a>
      </div>
    </div>

    <!-- Desktop Top Navigation -->
    <nav class="top desktop-nav" style="display: none;">
      <div class="container">
        <div class="row no-gap">
          <div class="col s12">
            <div class="nav-content">
              <div class="nav-logo">
                <h4 class="brand-title">LocalMarket</h4>
                <div class="logo-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="#F59E0B"/>
                    <path d="M12 6L12.5 8.5L15 9L12.5 9.5L12 12L11.5 9.5L9 9L11.5 8.5L12 6Z" fill="#FCD34D"/>
                  </svg>
                </div>
              </div>
              <div class="nav-links">
                <a href="../" class="nav-link" data-testid="nav-home"><i>home</i></a>
                <a href="../" class="nav-link" data-testid="nav-search"><i>search</i></a>
                <a href="../discussions/forums/" class="nav-link" data-testid="nav-discussions"><i>groups</i></a>
                <a href="../cart/index.html" class="nav-link" data-testid="nav-cart"><i>shopping_cart</i></a>
                <a href="../userprofile/index.html" class="nav-link" data-testid="nav-profile"><i>person</i></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav" style="display: flex; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; background-color: var(--surface-container); border-top: 1px solid var(--outline-variant); height: 60px;">
      <a href="../home/index.html" class="nav-item" data-testid="mobile-nav-home" style="padding: 12px 8px; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--on-surface);">
        <i>home</i>
      </a>
      <a href="../index.html" class="nav-item" data-testid="mobile-nav-search" style="padding: 12px 8px; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--on-surface);">
        <i>search</i>
      </a>
      <a href="../discussions/categories/local-discussions.html" class="nav-item" data-testid="mobile-nav-discussions" style="padding: 12px 8px; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--on-surface);">
        <i>groups</i>
      </a>
      <a href="../cart/index.html" class="nav-item" data-testid="mobile-nav-cart" style="padding: 12px 8px; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--on-surface);">
        <i>shopping_cart</i>
      </a>
      <a href="../userprofile/index.html" class="nav-item active" data-testid="mobile-nav-profile" style="padding: 12px 8px; flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--on-surface);">
        <i>person</i>
      </a>
    </nav>

    <main class="responsive" style="padding-bottom: 260px; padding-top: 2rem;">
        <!-- Add Product Hero Section -->
        <section class="events-hero">
            <div class="hero-banner">
                <img id="hero-banner-image" src="https://images.unsplash.com/photo-1542838132-92c53300491e?w=1200&h=400&fit=crop" 
                     alt="Product Banner" class="responsive round">
            </div>
        <!-- Add Product Form Section -->
        <section class="create-event-section">
            <div class="container">
                <div class="form-container">
                            <div class="form-header center">
                                <h2 class="form-title">Product Details</h2>
                                <p class="form-subtitle">Fill out the information below to add your product</p>
                            </div>
                    
                            <form class="event-form" hx-post="/api/create-product" hx-target="#form-result" hx-swap="innerHTML" data-testid="create-product-form">
                                <!-- Basic Information -->
                                <div class="form-section">
                                    <h3 class="section-title">Basic Information</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-name">Product Name *</label>
                                            <input type="text" id="product-name" name="name" required data-testid="product-name-input" placeholder="Enter product name">
                                        </div>
                                        <div class="form-group">
                                            <label for="product-category">Category *</label>
                                            <select id="product-category" name="category" required data-testid="product-category-select">
                                                <option value="">Select Category</option>
                                                <option value="produce">Fresh Produce</option>
                                                <option value="dairy">Dairy</option>
                                                <option value="eggs">Eggs</option>
                                                <option value="meat">Meat & Poultry</option>
                                                <option value="seafood">Seafood</option>
                                                <option value="bakery">Bakery</option>
                                                <option value="bread">Bread</option>
                                                <option value="baked-goods">Baked Goods</option>
                                                <option value="beverages">Beverages</option>
                                                <option value="tea">Tea</option>
                                                <option value="teas">Teas</option>
                                                <option value="cheese">Cheese</option>
                                                <option value="jam-preserves">Jam/Preserves</option>
                                                <option value="spices">Spices</option>
                                                <option value="dressings-condiments">Dressings/Condiments</option>
                                                <option value="confections-candies">Confections/Candies</option>
                                                <option value="dry-mixes">Dry Mixes</option>
                                                <option value="dried-foods">Dried Foods</option>
                                                <option value="hot-prepared-foods">Hot Prepared Foods</option>
                                                <option value="cold-prepared-foods">Cold Prepared Foods</option>
                                                <option value="prepared-foods">Prepared Foods</option>
                                                <option value="prepared">Prepared Foods (Legacy)</option>
                                                <option value="herbs">Herbs</option>
                                                <option value="plants">Plants</option>
                                                <option value="tinctures">Tinctures</option>
                                                <option value="handmade-crafts">Handmade Crafts</option>
                                                <option value="art">Art & Illustration</option>
                                                <option value="jewelry">Jewelry</option>
                                                <option value="clothing">Clothing & Accessories</option>
                                                <option value="woodworking">Woodworking</option>
                                                <option value="blacksmithing">Blacksmith</option>
                                                <option value="ceramics">Ceramics & Pottery</option>
                                                <option value="soap">Bath & Body / Soap</option>
                                                <option value="candles">Candles & Scents</option>
                                                <option value="home-decor">Home Decor</option>
                                                <option value="weaving">Weaving</option>
                                                <option value="stationery">Stationery & Paper Goods</option>
                                                <option value="specialty">Specialty Items</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="product-description">Description *</label>
                                        <textarea id="product-description" name="description" rows="4" required placeholder="Describe your product, its quality, and what makes it special..." data-testid="product-description-textarea"></textarea>
                                    </div>
                                </div>

                                <!-- Pricing & Inventory -->
                                <div class="form-section">
                                    <h3 class="section-title">Pricing & Inventory</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="product-price">Price *</label>
                                            <input type="number" id="product-price" name="price" min="0" step="0.01" required data-testid="product-price-input" placeholder="0.00">
                                        </div>
                                        <div class="form-group">
                                            <label for="stock-quantity">Stock Quantity *</label>
                                            <input type="number" id="stock-quantity" name="stock_quantity" min="0" required data-testid="stock-quantity-input" placeholder="0">
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Details -->
                                <div class="form-section">
                                    <h3 class="section-title">Product Details</h3>
                                    <div class="form-group">
                                        <label for="product-ingredients">Ingredients</label>
                                        <textarea id="product-ingredients" name="ingredients" rows="3" placeholder="List main ingredients or components (optional)..." data-testid="product-ingredients-textarea"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="additional-notes">Additional Notes</label>
                                        <textarea id="additional-notes" name="notes" rows="3" placeholder="Add any additional information, storage instructions, or special notes (optional)..." data-testid="additional-notes-textarea"></textarea>
                                    </div>
                                </div>

                                <!-- Product Media -->
                                <div class="form-section">
                                    <h3 class="section-title">Product Media</h3>
                                    <div class="form-group">
                                        <div class="row middle-align small-space wrap" style="margin-bottom: 2rem;">
                                            <img id="product-hero-preview" src="https://images.unsplash.com/photo-1542838132-92c53300491e?w=300&h=200&fit=crop" alt="Primary product preview" loading="lazy" class="round" style="max-width: 200px; max-height: 150px; object-fit: cover;">
                                            <div class="field label border round max">
                                                <input type="file" id="product-gallery" name="product_gallery[]" accept="image/*" multiple data-testid="product-gallery-input">
                                                <label>Add product photo</label>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label style="margin-bottom: 1rem; display: block; font-weight: 500; color: var(--on-surface); font-size: 0.9rem;">Gallery Photos</label>
                                            <div id="product-gallery-thumbnails" class="grid small-space"></div>
                                            <div id="product-gallery-empty" style="text-align: center; color: var(--on-surface-variant); font-size: 0.9rem; margin-top: 1rem;">No additional product images selected.</div>
                                            <div class="row right-align" style="margin-top: 1rem;">
                                                <button type="button" id="product-gallery-clear" class="chip border" style="display: none;">
                                                    <i>add</i>
                                                    <span>Add to gallery</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="form-actions center" style="margin-top: 3rem; margin-bottom: 6rem;">
                                    <button type="submit" class="btn primary submit-btn" data-testid="submit-btn">Add Product</button>
                                </div>

                                <div id="form-result"></div>
                            </form>
                            <div aria-hidden="true" style="height: 140px;"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('.event-form');
            const requiredFields = form.querySelectorAll('[required]');
            const productGalleryInput = document.getElementById('product-gallery');
            const galleryThumbnails = document.getElementById('product-gallery-thumbnails');
            const galleryEmptyState = document.getElementById('product-gallery-empty');
            const galleryClearButton = document.getElementById('product-gallery-clear');
            const heroBannerImage = document.getElementById('hero-banner-image');
            const productHeroPreview = document.getElementById('product-hero-preview');

            const initialBannerSrc = heroBannerImage ? heroBannerImage.src : '';
            const initialPreviewSrc = productHeroPreview ? productHeroPreview.src : '';
            const maxGalleryImages = 8;
            let galleryImages = [];

            function readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            function setPrimaryImage(src) {
                if (productHeroPreview) {
                    productHeroPreview.src = src;
                }
                if (heroBannerImage) {
                    heroBannerImage.src = src;
                }
            }

            function resetPrimaryImage() {
                if (productHeroPreview && initialPreviewSrc) {
                    productHeroPreview.src = initialPreviewSrc;
                }
                if (heroBannerImage && initialBannerSrc) {
                    heroBannerImage.src = initialBannerSrc;
                }
            }

            function renderGallery() {
                galleryThumbnails.innerHTML = '';

                if (!galleryImages.length) {
                    galleryEmptyState.style.display = 'block';
                    galleryClearButton.style.display = 'none';
                    resetPrimaryImage();
                    return;
                }

                galleryEmptyState.style.display = 'none';
                galleryClearButton.style.display = 'inline-flex';
                setPrimaryImage(galleryImages[0]);

                galleryImages.forEach((src, index) => {
                    const cell = document.createElement('div');
                    cell.className = 's6 m4 l3';
                    cell.innerHTML = `
                        <article class="round border" style="position: relative; padding-top: 100%; overflow: hidden;">
                            <img src="${src}" alt="Product image ${index + 1}" loading="lazy" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;">
                            <button type="button" class="circle transparent small" data-index="${index}" style="position: absolute; top: 0.35rem; right: 0.35rem; background-color: rgba(244, 67, 54, 0.9); color: white;">
                                <i style="color: white;">close</i>
                            </button>
                        </article>
                    `;
                    galleryThumbnails.appendChild(cell);
                });
            }

            function removeGalleryImage(index) {
                galleryImages.splice(index, 1);
                renderGallery();
            }

            galleryThumbnails.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-index]');
                if (!button) {
                    return;
                }
                const index = Number(button.getAttribute('data-index'));
                if (!Number.isNaN(index)) {
                    removeGalleryImage(index);
                }
            });

            galleryClearButton.addEventListener('click', () => {
                productGalleryInput.click();
            });

            productGalleryInput.addEventListener('change', async () => {
                const files = Array.from(productGalleryInput.files || []);
                if (!files.length) {
                    return;
                }

                for (const file of files) {
                    if (galleryImages.length >= maxGalleryImages) {
                        break;
                    }
                    try {
                        const dataUrl = await readFileAsDataURL(file);
                        galleryImages.push(dataUrl);
                    } catch (error) {
                        console.error('Unable to read file', error);
                    }
                }

                renderGallery();
                productGalleryInput.value = '';
            });

            requiredFields.forEach(field => {
                field.addEventListener('blur', function() {
                    validateField(this);
                });
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                let isValid = true;
                requiredFields.forEach(field => {
                    if (!validateField(field)) {
                        isValid = false;
                    }
                });

                if (isValid) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Adding Product...';
                    submitBtn.disabled = true;

                    setTimeout(() => {
                        document.getElementById('form-result').innerHTML = 
                            '<div style="color: #fffffe; background: rgba(255, 255, 254, 0.1); padding: 1rem; border-radius: 8px;">Product added successfully!</div>';
                        
                        form.reset();
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;

                        galleryImages = [];
                        renderGallery();
                    }, 2000);
                }
            });

            function validateField(field) {
                const value = field.value.trim();
                const isValid = value.length > 0;

                field.style.borderColor = '';
                const existingError = field.parentNode.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                if (!isValid) {
                    field.style.borderColor = '#ff6b6b';
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.style.color = '#ff6b6b';
                    errorMsg.style.fontSize = '0.8rem';
                    errorMsg.style.marginTop = '0.25rem';
                    errorMsg.textContent = 'This field is required';
                    field.parentNode.appendChild(errorMsg);
                }

                return isValid;
            }

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            renderGallery();
        });
    </script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.12.13/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
      // Theme Toggle Functionality
      (function() {
        // Get stored theme or default to light
        const storedTheme = localStorage.getItem('theme') || 'light';
        
        // Apply theme on page load
        document.body.classList.remove('dark', 'light');
        document.body.classList.add(storedTheme);
        
        // Create toggle button
        const toggleButton = document.createElement('button');
        toggleButton.className = 'theme-toggle circle';
        toggleButton.setAttribute('aria-label', 'Toggle theme');
        toggleButton.innerHTML = '<i>' + (storedTheme === 'light' ? 'dark_mode' : 'light_mode') + '</i>';
        
        // Add click handler
        toggleButton.addEventListener('click', function() {
          const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          
          document.body.classList.remove('dark', 'light');
          document.body.classList.add(newTheme);
          localStorage.setItem('theme', newTheme);
          
          toggleButton.querySelector('i').textContent = newTheme === 'light' ? 'dark_mode' : 'light_mode';
        });
        
        document.body.appendChild(toggleButton);
      })();
    </script>
  </body>
</html>

