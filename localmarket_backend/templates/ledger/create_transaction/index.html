{% extends 'ledger/index.html' %}

{% block title %}New Transaction - Django Ledger{% endblock %}

{% block content %}
  <h3>Create New Transaction</h3>
  
  <article class="padding">
    <form id="transaction-form">
      <div class="field border" style="margin-bottom: 2rem; position: relative;">
        <label for="transaction-date" style="display: block; margin-bottom: 0.1rem; color: var(--on-surface); font-size: 0.875rem;">Date</label>
        <input type="date" id="transaction-date" required style="padding-right: 3rem;">
        <button type="button" onclick="openDatePicker()" class="transparent circle" style="position: absolute; right: 0.5rem; top: 2.2rem; z-index: 1;" title="Open calendar">
          <i>calendar_today</i>
        </button>
      </div>
      
      <div class="field border" style="margin-bottom: 2rem;">
        <label for="reference-type" style="display: block; margin-bottom: 0.1rem; color: var(--on-surface); font-size: 0.875rem;">Reference Type</label>
        <input type="text" id="reference-type" required placeholder="order, payment, subscription, refund, manual">
      </div>
      
      <div class="field border" style="margin-bottom: 2rem;">
        <label for="transaction-description" style="display: block; margin-bottom: 0.1rem; color: var(--on-surface); font-size: 0.875rem;">Description</label>
        <input type="text" id="transaction-description" required>
      </div>
      
      <div class="field border" style="margin-bottom: 2rem;">
        <label for="reference-id" style="display: block; margin-bottom: 0.1rem; color: var(--on-surface); font-size: 0.875rem;">Reference ID (Optional)</label>
        <input type="text" id="reference-id" placeholder="External system ID">
      </div>
      
      <div class="space"></div>
      
      <nav class="right-align">
        <button type="button" onclick="window.location.href='{% url 'ledger:transactions' %}'" class="secondary">
          Back
        </button>
        <button type="button" onclick="goToEntryPage()" class="primary">
          Next
        </button>
      </nav>
    </form>
  </article>

  <script>
    // Load saved data from sessionStorage if available
    window.addEventListener('DOMContentLoaded', () => {
      const savedData = sessionStorage.getItem('transactionDetails');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          if (data.date) document.getElementById('transaction-date').value = data.date;
          if (data.reference_type) document.getElementById('reference-type').value = data.reference_type;
          if (data.description) document.getElementById('transaction-description').value = data.description;
          if (data.reference_id) document.getElementById('reference-id').value = data.reference_id;
        } catch (e) {
          console.error('Error loading saved data:', e);
        }
      }
      
      // Check if product data is provided from context
      {% if product %}
      const productData = {
        name: '{{ product.name|escapejs }}',
        price: {{ product.price }},
        id: '{{ product.id|escapejs }}'
      };
      
      // Autofill description with product name
      document.getElementById('transaction-description').value = productData.name;
      
      // Store product data in sessionStorage for use on entry page
      sessionStorage.setItem('productData', JSON.stringify(productData));
      {% endif %}
      
      // Set default date to today
      const dateInput = document.getElementById('transaction-date');
      if (!dateInput.value) {
        dateInput.valueAsDate = new Date();
      }
    });
    
    function openDatePicker() {
      const dateInput = document.getElementById('transaction-date');
      // Try modern showPicker() API, fallback to focus/click
      if (dateInput.showPicker) {
        dateInput.showPicker().catch(() => {
          // If showPicker fails, fallback to focus
          dateInput.focus();
          dateInput.click();
        });
      } else {
        // Fallback for browsers that don't support showPicker()
        dateInput.focus();
        dateInput.click();
      }
    }
    
    function goToEntryPage() {
      const form = document.getElementById('transaction-form');
      
      // Validate required fields
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Save form data to sessionStorage
      const transactionData = {
        date: document.getElementById('transaction-date').value,
        reference_type: document.getElementById('reference-type').value,
        description: document.getElementById('transaction-description').value,
        reference_id: document.getElementById('reference-id').value || ''
      };
      
      sessionStorage.setItem('transactionDetails', JSON.stringify(transactionData));
      
      // Navigate to entry page
      window.location.href = '{% url "ledger:create_transaction_entry" %}';
    }
  </script>
{% endblock %}

